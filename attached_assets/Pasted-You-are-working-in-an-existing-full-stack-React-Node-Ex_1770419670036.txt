You are working in an existing full-stack React + Node/Express + Postgres (Drizzle) application with:
- Admin area with CRM Leads
- An Admin “Projects” area intended to convert a Lead into a Project
- CMS + public renderer
- A public site with a main navigation

Current problem:
- The Admin does NOT show usable conversion controls to convert Leads → Projects (or they do not function).
- The public site has NO Projects/Portfolio page and no Projects button in the main nav.
- Projects are supposed to appear publicly as a portfolio grid.

CRITICAL RULES:
- NON-DESTRUCTIVE changes only.
- Do NOT remove or break existing routes, CMS, CRM, or pages.
- Prefer creating new files and adding new endpoints.
- If editing existing files, keep changes minimal and clearly commented.
- Ensure all new features are documented into Admin → Docs with categories.

GOAL:
Implement the complete “Lead → Project → Public Portfolio” workflow:
1) Admin: Convert a lead into a project (one-click + modal)
2) Admin: Manage projects (list, edit, publish/unpublish, attach images)
3) Public: Add “Projects” to main nav
4) Public: /projects page shows a portfolio grid of published projects
5) Public: /projects/:slug shows a project detail page with gallery, services, and CTA
6) Optional: Provide a CMS block that can display featured projects (if feasible without breaking existing CMS)

------------------------------------------------------------
PHASE 1 — DATABASE (DRIZZLE) — VERIFY/ADD PROJECTS TABLES
------------------------------------------------------------

1) Inspect current schema for an existing projects table (e.g., crm_projects).
If it exists, DO NOT replace it—extend it minimally if needed.
If it does not exist, add these tables:

A) projects
- id uuid pk default random
- createdAt timestamp default now not null
- updatedAt timestamp default now not null
- leadId uuid nullable references leads.id on delete set null
- slug text not null unique
- title text not null
- location text (e.g., “Matthews, NC”)
- county text
- services jsonb not null default '[]'    (array of service keys)
- summary text
- description text                        (long form; supports markdown/plain)
- featured boolean not null default false
- status text not null default 'draft'    (draft|published)
- publishedAt timestamp nullable
- coverImageUrl text
- coverImageAlt text
- beforeAfter jsonb not null default '[]' (array of { beforeUrl, beforeAlt, afterUrl, afterAlt, label })
- gallery jsonb not null default '[]'     (array of { url, alt, title })
- tags jsonb not null default '[]'

Indexes:
- unique slug
- index status
- index featured
- index publishedAt

B) project_activity (optional but recommended)
- id uuid pk
- projectId uuid references projects.id on delete cascade
- createdAt timestamp default now not null
- type text (CREATED_FROM_LEAD, UPDATED, PUBLISHED, UNPUBLISHED)
- payload jsonb

2) Create/Run Drizzle migration(s) (generate + migrate) without breaking existing migrations.

------------------------------------------------------------
PHASE 2 — BACKEND APIs (ADMIN + PUBLIC)
------------------------------------------------------------

A) ADMIN ENDPOINTS (protected; use existing admin auth/RBAC)
1) POST /api/admin/projects/from-lead/:leadId
- Creates a project from a lead
- Behavior:
  - If a project already exists for leadId, return 409 with existing project id
  - Default project fields:
    - title: “<Lead fullName> — <Primary service>”
    - location: from lead city/county if available
    - services: lead.servicesRequested
    - summary: first sentence derived from desiredOutcome (safe heuristic)
    - status: draft
    - slug: generated from title with uniqueness suffix if needed
- Return the created project

2) GET /api/admin/projects
- Supports filters: status, featured, service, search
- Pagination

3) GET /api/admin/projects/:id

4) PATCH /api/admin/projects/:id
- Update title, slug, summary, description, location, services, tags, gallery, beforeAfter, coverImage*
- Validate with zod (slug unique check)

5) POST /api/admin/projects/:id/publish
- status -> published, publishedAt now
6) POST /api/admin/projects/:id/unpublish
- status -> draft, publishedAt null

B) PUBLIC ENDPOINTS
1) GET /api/public/projects
- Returns only published projects
- Supports query params:
  - featured=true
  - service=key
  - limit, offset
- Return minimal list fields for grid:
  id, slug, title, location, summary, coverImageUrl, coverImageAlt, services, tags

2) GET /api/public/projects/:slug
- Returns full project detail (published only)
- Includes gallery + beforeAfter

Security:
- Ensure public endpoints never return draft projects.
- Ensure admin endpoints enforce auth.

------------------------------------------------------------
PHASE 3 — ADMIN UI: LEADS → CONVERT TO PROJECT
------------------------------------------------------------

A) Add “Convert to Project” controls in the CRM Leads UI:
Where to add:
- In lead detail view (/admin/leads/:id or equivalent):
  - Add a prominent button: “Convert to Project”
- In leads list (/admin/leads):
  - Add row action: “Create Project”
  - Optional bulk action later (not required)

Behavior:
- Clicking opens a modal:
  - confirms project title (editable)
  - confirms slug (auto-generated; editable)
  - select services (default from lead)
  - optional: mark as “featured”
  - optional: choose cover image from Media Library or paste URL
  - optional: import before/after from quick fields
- Submit calls POST /api/admin/projects/from-lead/:leadId
- On success: navigate to /admin/projects/:id edit page

If 409 exists:
- show “Project already exists” + button “Open Project”

B) Build/finish Admin Projects Manager:
Routes:
- /admin/projects (list)
- /admin/projects/:id (editor)

Admin Projects list:
- columns: title, location, status, featured, updatedAt, actions
- filters: status, featured, service
- search: title/location/tags
- actions: edit, publish/unpublish

Project editor (/admin/projects/:id):
Layout tabs:
1) Overview
- title, slug, location, county
- services multi-select
- summary + description (markdown or rich text)
- tags
- featured toggle
- status badge + publish/unpublish buttons

2) Media
- Cover image picker (media library modal)
- Gallery manager:
  - add images (from Media library or URL)
  - set alt text (required)
  - reorder
- Before/After manager:
  - add rows with before/after urls + alt + label
  - reorder

3) Preview
- Link to public preview if published
- Optional admin preview using ?previewToken (if that system exists)

Make sure all media selection reuses the existing Media library tooling.

------------------------------------------------------------
PHASE 4 — PUBLIC SITE: PROJECTS NAV + PORTFOLIO GRID + DETAIL PAGE
------------------------------------------------------------

A) Add a new main nav item: “Projects”
- Link to /projects
- Place near Services/Pricing
- Ensure mobile nav includes it as well

B) Create public pages (do not remove existing pages):
- /projects (Portfolio Grid)
- /projects/:slug (Project Detail)

/projects page requirements:
- SEO:
  Title: “Projects | BrushWhackers Charlotte, NC”
  Meta: “Explore before-and-after land clearing, brush removal, and forestry mulching projects across the Charlotte, NC region.”
- UI:
  - Header: “Project Portfolio”
  - Filters: Service (dropdown) + Featured toggle (optional)
  - Grid of Project cards (CardPro):
    - cover image (ImageFloat)
    - title
    - location
    - short summary
    - service tags
    - CTA: “View Project”
  - If no projects: friendly empty state + CTA to /quote

Data:
- Fetch from GET /api/public/projects with query params.

Project detail page requirements (/projects/:slug):
- SEO:
  Use project title + location; set meta description from summary.
  OG image from cover.
  Add JSON-LD (optional) as “Service” or “LocalBusiness” or “Article” (keep simple).
- Layout:
  - Hero: title + location + service tags + CTA to /quote
  - “About this project” section: summary + description
  - Gallery section: masonry or responsive grid
  - Before/After section:
    - reuse the BeforeAfterGallery block component if it exists
    - otherwise show before/after pairs as a clean compare/grid
  - Final CTA band: “Need similar results? Get a fast quote.”

------------------------------------------------------------
PHASE 5 — OPTIONAL CMS INTEGRATION: FEATURED PROJECTS BLOCK
------------------------------------------------------------

If the CMS block library system exists:
- Add a new system block:
  key: featured_projects
  name: Featured Projects
  category: CMS
  defaultProps:
    headline, subheadline, limit=6, showOnlyFeatured=true, ctaText, ctaHref="/projects"
- Renderer:
  - fetches GET /api/public/projects?featured=true&limit=...
  - renders cards consistent with /projects grid
- Admin inspector:
  - headline/subheadline
  - limit
  - showOnlyFeatured toggle

This is optional but recommended. Do not break existing CMS blocks.

------------------------------------------------------------
PHASE 6 — QUALITY + EDGE CASES
------------------------------------------------------------

- Slug uniqueness:
  - enforce at DB + API validation
  - friendly admin error message “Slug already in use”
- Alt text required for images:
  - validation warnings in admin
- Ensure converting from lead does NOT alter lead data (except optional tagging).
- Permissions:
  - Only Admin/SuperAdmin can publish projects.
  - Editors can edit content but not publish (if RBAC exists).

------------------------------------------------------------
END-OF-PROMPT REQUIREMENT — DOCS UPDATE (MANDATORY, CATEGORIZED)
------------------------------------------------------------

Update Admin → Docs with technical, thorough entries using categories and the standard template.

Category: CRM
- “Lead → Project Conversion Workflow”
  - UX locations, modal fields, 409 behavior, linkage to leadId

Category: CMS (if featured_projects block added)
- “Featured Projects Block”

Category: APIs
- “Projects APIs (Admin + Public)”
  - list each endpoint with request/response examples, auth requirements, filters

Category: Database
- “Projects Schema”
  - tables, columns, indexes, relationships, migrations, seed notes if any

Category: Routing
- “Public Projects Routes”
  - /projects and /projects/:slug behavior and data sources

Category: SEO
- “Projects SEO Rules”
  - titles, meta, OG, JSON-LD notes

Category: Security
- “Projects Publishing Permissions”
  - roles, guards, draft protection

Also:
- Add a “Change Log” doc entry for this prompt summarizing:
  Docs created: N
  Docs updated: N
  Categories touched: ...
  Key endpoints: ...
  Key tables: ...

FINAL CHECKS:
- Admin lead detail shows “Convert to Project” and it works
- Admin projects list and editor work
- Publishing a project makes it appear on /projects
- /projects/:slug loads project detail
- Nav includes “Projects”
- Docs updated, categorized, and easy to browse
